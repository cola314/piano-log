import { useState, useEffect, useCallback } from "react";

const CATEGORIES = [
  { id: "hanon", name: "하농", sub: "스케일", cycle: "주 1조성", daily: "5-10분", color: "#B8860B", bg: "#FDF6E3", icon: "♯" },
  { id: "czerny", name: "체르니 30", sub: "에튀드", cycle: "주 1곡", daily: "15-20분", color: "#8B4513", bg: "#FFF8F0", icon: "♪" },
  { id: "sonatine", name: "소나티네", sub: "악곡", cycle: "월 1곡", daily: "20분", color: "#2F4F4F", bg: "#F0F5F5", icon: "♫" },
];

const KEYS = ["C", "G", "D", "A", "E", "B", "F♯/G♭", "D♭", "A♭", "E♭", "B♭", "F"];
const SCALE_TYPES = ["장조", "자연단조", "화성단조", "가락단조"];

const STORAGE_KEY = "piano-practice-data";

function getWeekNumber(d) {
  const date = new Date(d);
  date.setHours(0, 0, 0, 0);
  date.setDate(date.getDate() + 3 - ((date.getDay() + 6) % 7));
  const week1 = new Date(date.getFullYear(), 0, 4);
  return 1 + Math.round(((date - week1) / 86400000 - 3 + ((week1.getDay() + 6) % 7)) / 7);
}

function getMonthKey(d) {
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
}

function getWeekKey(d) {
  return `${d.getFullYear()}-W${String(getWeekNumber(d)).padStart(2, "0")}`;
}

function getDayKey(d) {
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
}

function formatDate(d) {
  const days = ["일", "월", "화", "수", "목", "금", "토"];
  return `${d.getMonth() + 1}월 ${d.getDate()}일 (${days[d.getDay()]})`;
}

function getCalendarDays(year, month) {
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const days = [];
  const startPad = (firstDay.getDay() + 6) % 7;
  for (let i = startPad - 1; i >= 0; i--) {
    const d = new Date(year, month, -i);
    days.push({ date: d, current: false });
  }
  for (let i = 1; i <= lastDay.getDate(); i++) {
    days.push({ date: new Date(year, month, i), current: true });
  }
  const remaining = 42 - days.length;
  for (let i = 1; i <= remaining; i++) {
    days.push({ date: new Date(year, month + 1, i), current: false });
  }
  return days;
}

const defaultData = () => ({
  logs: {},
  goals: {
    hanon: {},
    czerny: {},
    sonatine: {},
  },
});

export default function PracticeTracker() {
  const [data, setData] = useState(defaultData);
  const [selectedDate, setSelectedDate] = useState(new Date());
  const [viewMonth, setViewMonth] = useState({ year: new Date().getFullYear(), month: new Date().getMonth() });
  const [activeTab, setActiveTab] = useState("today");
  const [showLogModal, setShowLogModal] = useState(false);
  const [logForm, setLogForm] = useState({ hanon: 0, czerny: 0, sonatine: 0, note: "" });
  const [goalForm, setGoalForm] = useState({ category: "hanon", title: "", weekKey: "" });
  const [showGoalModal, setShowGoalModal] = useState(false);
  const [hanonStep, setHanonStep] = useState(0); // 0: pick key, 1: pick scale type
  const [hanonKey, setHanonKey] = useState("");
  const [timerCat, setTimerCat] = useState(null); // which category is running
  const [timerElapsed, setTimerElapsed] = useState({ hanon: 0, czerny: 0, sonatine: 0 }); // seconds elapsed
  const [timerTargets, setTimerTargets] = useState({ hanon: 600, czerny: 1200, sonatine: 1200 }); // target in seconds
  const [timerRunning, setTimerRunning] = useState(false);
  const [timerNote, setTimerNote] = useState("");
  const [timerAlerted, setTimerAlerted] = useState({ hanon: false, czerny: false, sonatine: false });

  useEffect(() => {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) setData(JSON.parse(saved));
    } catch (e) {}
  }, []);

  const save = useCallback((newData) => {
    setData(newData);
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(newData)); } catch (e) {}
  }, []);

  // Play beep sound
  const playAlarm = useCallback(() => {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const playTone = (freq, startTime, duration) => {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = freq;
        osc.type = "sine";
        gain.gain.setValueAtTime(0.3, startTime);
        gain.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
        osc.start(startTime);
        osc.stop(startTime + duration);
      };
      playTone(880, ctx.currentTime, 0.15);
      playTone(880, ctx.currentTime + 0.2, 0.15);
      playTone(1100, ctx.currentTime + 0.4, 0.3);
    } catch (e) {}
  }, []);

  // Timer tick (counts up)
  useEffect(() => {
    if (!timerRunning || !timerCat) return;
    const interval = setInterval(() => {
      setTimerElapsed((prev) => {
        const newVal = prev[timerCat] + 1;
        // Check if just crossed the target
        if (newVal === timerTargets[timerCat] && !timerAlerted[timerCat]) {
          playAlarm();
          setTimerAlerted((a) => ({ ...a, [timerCat]: true }));
        }
        return { ...prev, [timerCat]: newVal };
      });
    }, 1000);
    return () => clearInterval(interval);
  }, [timerRunning, timerCat, timerTargets, timerAlerted, playAlarm]);

  const startTimer = (catId) => {
    if (timerRunning && timerCat === catId) {
      setTimerRunning(false);
    } else {
      setTimerCat(catId);
      setTimerRunning(true);
    }
  };

  const resetTimer = (catId) => {
    if (timerCat === catId) setTimerRunning(false);
    setTimerElapsed((prev) => ({ ...prev, [catId]: 0 }));
    setTimerAlerted((prev) => ({ ...prev, [catId]: false }));
  };

  const setTarget = (catId, minutes) => {
    setTimerTargets((prev) => ({ ...prev, [catId]: minutes * 60 }));
    if (timerElapsed[catId] === 0) {
      setTimerAlerted((prev) => ({ ...prev, [catId]: false }));
    }
  };

  const saveTimerToLog = () => {
    const tk = getDayKey(new Date());
    const existing = data.logs[tk] || { hanon: 0, czerny: 0, sonatine: 0, note: "" };
    const newLog = {
      ...existing,
      hanon: (existing.hanon || 0) + Math.round(timerElapsed.hanon / 60),
      czerny: (existing.czerny || 0) + Math.round(timerElapsed.czerny / 60),
      sonatine: (existing.sonatine || 0) + Math.round(timerElapsed.sonatine / 60),
      note: timerNote ? (existing.note ? existing.note + " | " + timerNote : timerNote) : existing.note,
      date: tk,
    };
    const newData = { ...data, logs: { ...data.logs, [tk]: newLog } };
    save(newData);
    setTimerRunning(false);
    setTimerCat(null);
    setTimerElapsed({ hanon: 0, czerny: 0, sonatine: 0 });
    setTimerAlerted({ hanon: false, czerny: false, sonatine: false });
    setTimerNote("");
  };

  const formatTimer = (secs) => {
    const absSecs = Math.abs(secs);
    const m = Math.floor(absSecs / 60);
    const s = absSecs % 60;
    return `${secs < 0 ? "-" : ""}${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
  };

  const getRemaining = (catId) => timerTargets[catId] - timerElapsed[catId];
  const totalElapsed = timerElapsed.hanon + timerElapsed.czerny + timerElapsed.sonatine;
  const totalTarget = timerTargets.hanon + timerTargets.czerny + timerTargets.sonatine;

  const dayKey = getDayKey(selectedDate);
  const todayKey = getDayKey(new Date());
  const weekKey = getWeekKey(selectedDate);
  const monthKey = getMonthKey(selectedDate);
  const todayLog = data.logs[dayKey];

  const calendarDays = getCalendarDays(viewMonth.year, viewMonth.month);

  const handleSaveLog = () => {
    const newData = { ...data, logs: { ...data.logs, [dayKey]: { ...logForm, date: dayKey } } };
    save(newData);
    setShowLogModal(false);
  };

  const handleSaveGoal = () => {
    if (!goalForm.title.trim()) return;
    const key = goalForm.category === "sonatine" ? monthKey : weekKey;
    const newData = {
      ...data,
      goals: {
        ...data.goals,
        [goalForm.category]: {
          ...data.goals[goalForm.category],
          [key]: { title: goalForm.title, completed: false },
        },
      },
    };
    save(newData);
    setShowGoalModal(false);
    setGoalForm({ category: "hanon", title: "", weekKey: "" });
  };

  const toggleGoalComplete = (cat, key) => {
    const newData = {
      ...data,
      goals: {
        ...data.goals,
        [cat]: {
          ...data.goals[cat],
          [key]: { ...data.goals[cat][key], completed: !data.goals[cat][key]?.completed },
        },
      },
    };
    save(newData);
  };

  const openLogModal = () => {
    const existing = data.logs[dayKey];
    setLogForm(existing || { hanon: 0, czerny: 0, sonatine: 0, note: "" });
    setShowLogModal(true);
  };

  const getLogDots = (date) => {
    const dk = getDayKey(date);
    const log = data.logs[dk];
    if (!log) return [];
    const dots = [];
    if (log.hanon > 0) dots.push(CATEGORIES[0].color);
    if (log.czerny > 0) dots.push(CATEGORIES[1].color);
    if (log.sonatine > 0) dots.push(CATEGORIES[2].color);
    return dots;
  };

  const getWeeklyStats = () => {
    const startOfWeek = new Date(selectedDate);
    const dayOfWeek = (startOfWeek.getDay() + 6) % 7;
    startOfWeek.setDate(startOfWeek.getDate() - dayOfWeek);
    const stats = { hanon: 0, czerny: 0, sonatine: 0, days: 0 };
    for (let i = 0; i < 7; i++) {
      const d = new Date(startOfWeek);
      d.setDate(d.getDate() + i);
      const log = data.logs[getDayKey(d)];
      if (log) {
        stats.hanon += log.hanon || 0;
        stats.czerny += log.czerny || 0;
        stats.sonatine += log.sonatine || 0;
        if ((log.hanon || 0) + (log.czerny || 0) + (log.sonatine || 0) > 0) stats.days++;
      }
    }
    return stats;
  };

  const getStreak = () => {
    let streak = 0;
    const d = new Date();
    while (true) {
      const log = data.logs[getDayKey(d)];
      if (log && ((log.hanon || 0) + (log.czerny || 0) + (log.sonatine || 0) > 0)) {
        streak++;
        d.setDate(d.getDate() - 1);
      } else {
        break;
      }
    }
    return streak;
  };

  const weeklyStats = getWeeklyStats();
  const streak = getStreak();

  const navMonth = (dir) => {
    setViewMonth((prev) => {
      let m = prev.month + dir;
      let y = prev.year;
      if (m < 0) { m = 11; y--; }
      if (m > 11) { m = 0; y++; }
      return { year: y, month: m };
    });
  };

  return (
    <div style={{
      minHeight: "100vh",
      background: "linear-gradient(160deg, #1a1207 0%, #2a1f0e 30%, #1e1e2e 70%, #0f0f1a 100%)",
      fontFamily: "'Noto Serif KR', 'Georgia', serif",
      color: "#E8DCC8",
      padding: "0",
    }}>
      <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@300;400;500;600;700&family=Crimson+Pro:wght@300;400;500;600&display=swap" rel="stylesheet" />
      <style>{`
        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.5; }
        }
      `}</style>

      {/* Header */}
      <div style={{
        background: "linear-gradient(180deg, rgba(184,134,11,0.15) 0%, transparent 100%)",
        borderBottom: "1px solid rgba(184,134,11,0.2)",
        padding: "28px 24px 20px",
        textAlign: "center",
      }}>
        <div style={{ fontSize: "11px", letterSpacing: "6px", color: "#B8860B", marginBottom: "8px", fontFamily: "'Crimson Pro', serif" }}>
          PIANO PRACTICE
        </div>
        <h1 style={{
          fontSize: "28px",
          fontWeight: "300",
          margin: 0,
          letterSpacing: "2px",
          color: "#F5E6C8",
        }}>
          연습 기록장
        </h1>
        <div style={{
          display: "flex",
          justifyContent: "center",
          gap: "32px",
          marginTop: "20px",
        }}>
          <div style={{ textAlign: "center" }}>
            <div style={{ fontSize: "24px", fontWeight: "600", color: "#B8860B", fontFamily: "'Crimson Pro', serif" }}>{streak}</div>
            <div style={{ fontSize: "10px", letterSpacing: "2px", color: "#8B7355", marginTop: "2px" }}>연속일</div>
          </div>
          <div style={{ width: "1px", background: "rgba(184,134,11,0.2)" }} />
          <div style={{ textAlign: "center" }}>
            <div style={{ fontSize: "24px", fontWeight: "600", color: "#B8860B", fontFamily: "'Crimson Pro', serif" }}>{weeklyStats.days}</div>
            <div style={{ fontSize: "10px", letterSpacing: "2px", color: "#8B7355", marginTop: "2px" }}>이번 주</div>
          </div>
          <div style={{ width: "1px", background: "rgba(184,134,11,0.2)" }} />
          <div style={{ textAlign: "center" }}>
            <div style={{ fontSize: "24px", fontWeight: "600", color: "#B8860B", fontFamily: "'Crimson Pro', serif" }}>{weeklyStats.hanon + weeklyStats.czerny + weeklyStats.sonatine}</div>
            <div style={{ fontSize: "10px", letterSpacing: "2px", color: "#8B7355", marginTop: "2px" }}>주간(분)</div>
          </div>
        </div>
      </div>

      {/* Tabs */}
      <div style={{
        display: "flex",
        borderBottom: "1px solid rgba(184,134,11,0.15)",
        background: "rgba(0,0,0,0.2)",
      }}>
        {[
          { id: "today", label: "오늘" },
          { id: "calendar", label: "달력" },
          { id: "progress", label: "진도" },
          { id: "stats", label: "통계" },
        ].map((tab) => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id)}
            style={{
              flex: 1,
              padding: "14px",
              background: "none",
              border: "none",
              borderBottom: activeTab === tab.id ? "2px solid #B8860B" : "2px solid transparent",
              color: activeTab === tab.id ? "#F5E6C8" : "#6B5B45",
              fontSize: "13px",
              fontFamily: "'Noto Serif KR', serif",
              cursor: "pointer",
              letterSpacing: "2px",
              transition: "all 0.3s",
            }}
          >
            {tab.label}
          </button>
        ))}
      </div>

      <div style={{ padding: "20px", maxWidth: "480px", margin: "0 auto" }}>

        {/* Today Tab */}
        {activeTab === "today" && (
          <div>
            {/* Date */}
            <div style={{ textAlign: "center", marginBottom: "24px" }}>
              <div style={{ fontSize: "14px", color: "#8B7355" }}>{formatDate(new Date())}</div>
            </div>

            {/* Total Timer Display */}
            <div style={{
              textAlign: "center",
              marginBottom: "28px",
              padding: "24px",
              background: "rgba(184,134,11,0.06)",
              borderRadius: "16px",
              border: "1px solid rgba(184,134,11,0.12)",
            }}>
              <div style={{ fontSize: "10px", letterSpacing: "3px", color: "#6B5B45", marginBottom: "10px" }}>
                총 남은 시간
              </div>
              {(() => {
                const totalRemaining = totalTarget - totalElapsed;
                const isOvertime = totalRemaining < 0;
                return (
                  <div style={{
                    fontSize: "48px",
                    fontWeight: "300",
                    fontFamily: "'Crimson Pro', serif",
                    color: isOvertime ? "#C0392B" : timerRunning ? "#F5E6C8" : "#B8860B",
                    letterSpacing: "4px",
                    transition: "color 0.3s",
                  }}>
                    {isOvertime && <span style={{ fontSize: "24px", verticalAlign: "middle", marginRight: "4px", color: "#C0392B" }}>+</span>}
                    {formatTimer(Math.abs(totalRemaining))}
                  </div>
                );
              })()}
              <div style={{
                marginTop: "6px",
                fontSize: "11px",
                color: "#5A4E3A",
              }}>
                경과 {formatTimer(totalElapsed)} / 목표 {formatTimer(totalTarget)}
              </div>
              {timerRunning && timerCat && (
                <div style={{
                  marginTop: "8px",
                  fontSize: "11px",
                  color: CATEGORIES.find(c => c.id === timerCat)?.color,
                  letterSpacing: "1px",
                  animation: "pulse 2s ease-in-out infinite",
                }}>
                  ● {CATEGORIES.find(c => c.id === timerCat)?.name} 연습 중
                </div>
              )}
            </div>

            {/* Category Timers */}
            {CATEGORIES.map((cat) => {
              const isActive = timerRunning && timerCat === cat.id;
              const elapsed = timerElapsed[cat.id];
              const remaining = getRemaining(cat.id);
              const isOvertime = remaining < 0;
              const progress = Math.min(elapsed / timerTargets[cat.id], 1) * 100;
              const targetMin = timerTargets[cat.id] / 60;
              return (
                <div key={cat.id} style={{
                  marginBottom: "12px",
                  padding: "16px 20px",
                  background: isActive
                    ? `linear-gradient(135deg, ${cat.color}18 0%, ${cat.color}08 100%)`
                    : "rgba(0,0,0,0.15)",
                  borderRadius: "12px",
                  border: isOvertime && elapsed > 0
                    ? "1px solid rgba(192,57,43,0.3)"
                    : isActive ? `1px solid ${cat.color}40` : "1px solid rgba(184,134,11,0.08)",
                  transition: "all 0.3s",
                }}>
                  {/* Top row: info + countdown + controls */}
                  <div style={{
                    display: "flex",
                    alignItems: "center",
                    justifyContent: "space-between",
                  }}>
                    <div style={{ display: "flex", alignItems: "center", gap: "12px" }}>
                      <div style={{
                        width: "40px",
                        height: "40px",
                        borderRadius: "10px",
                        background: isActive ? `${cat.color}30` : "rgba(184,134,11,0.08)",
                        display: "flex",
                        alignItems: "center",
                        justifyContent: "center",
                        fontSize: "18px",
                        color: cat.color,
                        transition: "all 0.3s",
                      }}>
                        {cat.icon}
                      </div>
                      <div>
                        <div style={{ fontSize: "14px", fontWeight: "500" }}>{cat.name}</div>
                        <div style={{ fontSize: "10px", color: "#6B5B45", marginTop: "2px" }}>목표 {targetMin}분</div>
                      </div>
                    </div>

                    <div style={{ display: "flex", alignItems: "center", gap: "12px" }}>
                      <div style={{ textAlign: "right" }}>
                        <div style={{
                          fontSize: "22px",
                          fontFamily: "'Crimson Pro', serif",
                          color: isOvertime && elapsed > 0
                            ? "#C0392B"
                            : isActive ? "#F5E6C8" : remaining < timerTargets[cat.id] && elapsed > 0 ? "#B8860B" : "#4A3F30",
                          letterSpacing: "2px",
                          fontWeight: isActive ? "500" : "300",
                        }}>
                          {isOvertime && elapsed > 0 ? "+" : ""}{formatTimer(Math.abs(remaining))}
                        </div>
                        {elapsed > 0 && (
                          <div style={{ fontSize: "9px", color: "#5A4E3A", marginTop: "1px" }}>
                            경과 {formatTimer(elapsed)}
                          </div>
                        )}
                      </div>

                      <div style={{ display: "flex", gap: "6px" }}>
                        <button
                          onClick={() => startTimer(cat.id)}
                          style={{
                            width: "36px",
                            height: "36px",
                            borderRadius: "50%",
                            border: `1.5px solid ${isActive ? cat.color : "rgba(184,134,11,0.2)"}`,
                            background: isActive ? `${cat.color}25` : "rgba(0,0,0,0.2)",
                            color: isActive ? "#F5E6C8" : "#8B7355",
                            fontSize: "14px",
                            cursor: "pointer",
                            display: "flex",
                            alignItems: "center",
                            justifyContent: "center",
                            transition: "all 0.2s",
                          }}
                        >
                          {isActive ? "❚❚" : "▶"}
                        </button>

                        {elapsed > 0 && (
                          <button
                            onClick={() => resetTimer(cat.id)}
                            style={{
                              width: "36px",
                              height: "36px",
                              borderRadius: "50%",
                              border: "1.5px solid rgba(184,134,11,0.15)",
                              background: "rgba(0,0,0,0.2)",
                              color: "#6B5B45",
                              fontSize: "12px",
                              cursor: "pointer",
                              display: "flex",
                              alignItems: "center",
                              justifyContent: "center",
                            }}
                          >
                            ↺
                          </button>
                        )}
                      </div>
                    </div>
                  </div>

                  {/* Progress bar */}
                  <div style={{
                    marginTop: "12px",
                    height: "4px",
                    background: "rgba(0,0,0,0.3)",
                    borderRadius: "2px",
                    overflow: "hidden",
                  }}>
                    <div style={{
                      height: "100%",
                      width: `${Math.min(progress, 100)}%`,
                      background: isOvertime
                        ? "linear-gradient(90deg, #C0392B88, #C0392B)"
                        : `linear-gradient(90deg, ${cat.color}88, ${cat.color})`,
                      borderRadius: "2px",
                      transition: "width 0.5s ease",
                    }} />
                  </div>

                  {/* Target time adjustment (shown when not running and no elapsed) */}
                  {elapsed === 0 && !isActive && (
                    <div style={{
                      marginTop: "10px",
                      display: "flex",
                      gap: "5px",
                      justifyContent: "center",
                    }}>
                      {[5, 10, 15, 20, 25, 30].map((m) => (
                        <button
                          key={m}
                          onClick={() => setTarget(cat.id, m)}
                          style={{
                            padding: "4px 10px",
                            borderRadius: "4px",
                            border: targetMin === m ? `1px solid ${cat.color}` : "1px solid rgba(184,134,11,0.1)",
                            background: targetMin === m ? `${cat.color}20` : "transparent",
                            color: targetMin === m ? "#F5E6C8" : "#5A4E3A",
                            fontSize: "11px",
                            cursor: "pointer",
                            fontFamily: "'Crimson Pro', serif",
                            transition: "all 0.15s",
                          }}
                        >
                          {m}분
                        </button>
                      ))}
                    </div>
                  )}
                </div>
              );
            })}

            {/* Note + Save */}
            {totalElapsed > 0 && (
              <div style={{
                marginTop: "24px",
                padding: "20px",
                background: "rgba(184,134,11,0.06)",
                borderRadius: "12px",
                border: "1px solid rgba(184,134,11,0.12)",
              }}>
                <textarea
                  value={timerNote}
                  onChange={(e) => setTimerNote(e.target.value)}
                  placeholder="오늘의 연습 메모..."
                  rows={2}
                  style={{
                    width: "100%",
                    background: "rgba(0,0,0,0.2)",
                    border: "1px solid rgba(184,134,11,0.15)",
                    borderRadius: "8px",
                    padding: "10px",
                    color: "#E8DCC8",
                    fontSize: "13px",
                    fontFamily: "'Noto Serif KR', serif",
                    resize: "none",
                    outline: "none",
                    boxSizing: "border-box",
                    marginBottom: "12px",
                  }}
                />
                <button
                  onClick={saveTimerToLog}
                  style={{
                    width: "100%",
                    padding: "14px",
                    background: "linear-gradient(135deg, rgba(184,134,11,0.3) 0%, rgba(184,134,11,0.15) 100%)",
                    border: "1px solid rgba(184,134,11,0.4)",
                    borderRadius: "10px",
                    color: "#F5E6C8",
                    fontSize: "14px",
                    cursor: "pointer",
                    fontFamily: "'Noto Serif KR', serif",
                    fontWeight: "500",
                    letterSpacing: "2px",
                    transition: "all 0.2s",
                  }}
                >
                  연습 완료 · 저장하기
                </button>
                <div style={{
                  marginTop: "8px",
                  fontSize: "11px",
                  color: "#5A4E3A",
                  textAlign: "center",
                }}>
                  하농 {Math.round(timerElapsed.hanon / 60)}분 · 체르니 {Math.round(timerElapsed.czerny / 60)}분 · 소나티네 {Math.round(timerElapsed.sonatine / 60)}분으로 기록됩니다
                </div>
              </div>
            )}

            {/* Today's existing log */}
            {(() => {
              const tk = getDayKey(new Date());
              const existingLog = data.logs[tk];
              if (!existingLog) return null;
              const total = (existingLog.hanon || 0) + (existingLog.czerny || 0) + (existingLog.sonatine || 0);
              if (total === 0) return null;
              return (
                <div style={{
                  marginTop: "20px",
                  padding: "16px 20px",
                  background: "rgba(0,0,0,0.15)",
                  borderRadius: "12px",
                  border: "1px solid rgba(184,134,11,0.08)",
                }}>
                  <div style={{ fontSize: "11px", letterSpacing: "2px", color: "#6B5B45", marginBottom: "10px" }}>
                    오늘 누적 기록
                  </div>
                  <div style={{ display: "flex", justifyContent: "space-around" }}>
                    {CATEGORIES.map((cat) => (
                      <div key={cat.id} style={{ textAlign: "center" }}>
                        <div style={{ fontSize: "18px", fontFamily: "'Crimson Pro', serif", color: "#B8860B" }}>
                          {existingLog[cat.id] || 0}
                        </div>
                        <div style={{ fontSize: "10px", color: "#5A4E3A", marginTop: "2px" }}>{cat.name} (분)</div>
                      </div>
                    ))}
                  </div>
                  {existingLog.note && (
                    <div style={{
                      marginTop: "10px",
                      fontSize: "12px",
                      color: "#8B7355",
                      fontStyle: "italic",
                      textAlign: "center",
                    }}>
                      "{existingLog.note}"
                    </div>
                  )}
                </div>
              );
            })()}
          </div>
        )}

        {/* Calendar Tab */}
        {activeTab === "calendar" && (
          <div>
            {/* Month Navigation */}
            <div style={{
              display: "flex",
              justifyContent: "space-between",
              alignItems: "center",
              marginBottom: "20px",
            }}>
              <button onClick={() => navMonth(-1)} style={navBtnStyle}>‹</button>
              <div style={{ fontSize: "16px", fontWeight: "500", letterSpacing: "1px" }}>
                {viewMonth.year}년 {viewMonth.month + 1}월
              </div>
              <button onClick={() => navMonth(1)} style={navBtnStyle}>›</button>
            </div>

            {/* Day Headers */}
            <div style={{ display: "grid", gridTemplateColumns: "repeat(7, 1fr)", gap: "2px", marginBottom: "4px" }}>
              {["월", "화", "수", "목", "금", "토", "일"].map((d) => (
                <div key={d} style={{
                  textAlign: "center",
                  fontSize: "10px",
                  color: "#6B5B45",
                  letterSpacing: "2px",
                  padding: "6px 0",
                }}>
                  {d}
                </div>
              ))}
            </div>

            {/* Calendar Grid */}
            <div style={{ display: "grid", gridTemplateColumns: "repeat(7, 1fr)", gap: "2px" }}>
              {calendarDays.map(({ date, current }, i) => {
                const dk = getDayKey(date);
                const isToday = dk === todayKey;
                const isSelected = dk === dayKey;
                const dots = getLogDots(date);
                return (
                  <button
                    key={i}
                    onClick={() => {
                      setSelectedDate(new Date(date));
                    }}
                    style={{
                      aspectRatio: "1",
                      background: isSelected
                        ? "rgba(184,134,11,0.25)"
                        : isToday
                        ? "rgba(184,134,11,0.08)"
                        : "transparent",
                      border: isToday ? "1px solid rgba(184,134,11,0.4)" : "1px solid transparent",
                      borderRadius: "8px",
                      color: current ? (isSelected ? "#F5E6C8" : "#C4B49A") : "#3D3525",
                      fontSize: "13px",
                      cursor: "pointer",
                      display: "flex",
                      flexDirection: "column",
                      alignItems: "center",
                      justifyContent: "center",
                      gap: "3px",
                      fontFamily: "'Crimson Pro', serif",
                      transition: "all 0.2s",
                    }}
                  >
                    <span>{date.getDate()}</span>
                    {dots.length > 0 && (
                      <div style={{ display: "flex", gap: "2px" }}>
                        {dots.map((c, j) => (
                          <div key={j} style={{
                            width: "4px",
                            height: "4px",
                            borderRadius: "50%",
                            background: c,
                          }} />
                        ))}
                      </div>
                    )}
                  </button>
                );
              })}
            </div>

            {/* Selected Day Info */}
            <div style={{
              marginTop: "24px",
              padding: "20px",
              background: "rgba(184,134,11,0.06)",
              borderRadius: "12px",
              border: "1px solid rgba(184,134,11,0.12)",
            }}>
              <div style={{
                display: "flex",
                justifyContent: "space-between",
                alignItems: "center",
                marginBottom: "16px",
              }}>
                <div style={{ fontSize: "14px", fontWeight: "500" }}>
                  {formatDate(selectedDate)}
                </div>
                <button onClick={openLogModal} style={{
                  background: "rgba(184,134,11,0.2)",
                  border: "1px solid rgba(184,134,11,0.3)",
                  color: "#F5E6C8",
                  padding: "6px 16px",
                  borderRadius: "6px",
                  fontSize: "12px",
                  cursor: "pointer",
                  fontFamily: "'Noto Serif KR', serif",
                  letterSpacing: "1px",
                }}>
                  {todayLog ? "수정" : "기록"}
                </button>
              </div>

              {todayLog ? (
                <div>
                  {CATEGORIES.map((cat) => {
                    const mins = todayLog[cat.id] || 0;
                    return (
                      <div key={cat.id} style={{
                        display: "flex",
                        alignItems: "center",
                        justifyContent: "space-between",
                        padding: "8px 0",
                        borderBottom: "1px solid rgba(184,134,11,0.08)",
                      }}>
                        <div style={{ display: "flex", alignItems: "center", gap: "8px" }}>
                          <span style={{ color: cat.color, fontSize: "16px" }}>{cat.icon}</span>
                          <span style={{ fontSize: "13px" }}>{cat.name}</span>
                        </div>
                        <div style={{
                          fontSize: "14px",
                          color: mins > 0 ? "#B8860B" : "#4A3F30",
                          fontFamily: "'Crimson Pro', serif",
                          fontWeight: mins > 0 ? "500" : "300",
                        }}>
                          {mins}분
                        </div>
                      </div>
                    );
                  })}
                  {todayLog.note && (
                    <div style={{
                      marginTop: "12px",
                      fontSize: "12px",
                      color: "#8B7355",
                      fontStyle: "italic",
                      lineHeight: "1.6",
                    }}>
                      "{todayLog.note}"
                    </div>
                  )}
                </div>
              ) : (
                <div style={{ fontSize: "13px", color: "#5A4E3A", textAlign: "center", padding: "12px 0" }}>
                  아직 기록이 없습니다
                </div>
              )}
            </div>
          </div>
        )}

        {/* Progress Tab */}
        {activeTab === "progress" && (
          <div>
            <div style={{
              display: "flex",
              justifyContent: "space-between",
              alignItems: "center",
              marginBottom: "20px",
            }}>
              <div style={{ fontSize: "14px", color: "#8B7355" }}>
                {getWeekKey(selectedDate)} · {getMonthKey(selectedDate)}
              </div>
              <button onClick={() => { setShowGoalModal(true); setHanonStep(0); setHanonKey(""); }} style={{
                background: "rgba(184,134,11,0.2)",
                border: "1px solid rgba(184,134,11,0.3)",
                color: "#F5E6C8",
                padding: "6px 16px",
                borderRadius: "6px",
                fontSize: "12px",
                cursor: "pointer",
                fontFamily: "'Noto Serif KR', serif",
                letterSpacing: "1px",
              }}>
                + 목표 설정
              </button>
            </div>

            {CATEGORIES.map((cat) => {
              const key = cat.id === "sonatine" ? monthKey : weekKey;
              const goal = data.goals[cat.id]?.[key];
              return (
                <div key={cat.id} style={{
                  marginBottom: "16px",
                  padding: "20px",
                  background: `linear-gradient(135deg, ${cat.color}10 0%, transparent 100%)`,
                  borderRadius: "12px",
                  border: `1px solid ${cat.color}25`,
                }}>
                  <div style={{
                    display: "flex",
                    alignItems: "center",
                    justifyContent: "space-between",
                    marginBottom: "12px",
                  }}>
                    <div>
                      <div style={{ display: "flex", alignItems: "center", gap: "8px" }}>
                        <span style={{ color: cat.color, fontSize: "18px" }}>{cat.icon}</span>
                        <span style={{ fontSize: "15px", fontWeight: "500" }}>{cat.name}</span>
                      </div>
                      <div style={{ fontSize: "11px", color: "#6B5B45", marginTop: "4px", letterSpacing: "1px" }}>
                        {cat.cycle} · {cat.daily}
                      </div>
                    </div>
                    <div style={{
                      fontSize: "10px",
                      padding: "3px 10px",
                      borderRadius: "12px",
                      background: cat.id === "sonatine" ? "rgba(47,79,79,0.2)" : "rgba(184,134,11,0.15)",
                      color: cat.color,
                      letterSpacing: "1px",
                    }}>
                      {cat.id === "sonatine" ? "월간" : "주간"}
                    </div>
                  </div>

                  {goal ? (
                    <div
                      onClick={() => toggleGoalComplete(cat.id, key)}
                      style={{
                        display: "flex",
                        alignItems: "center",
                        gap: "10px",
                        padding: "12px",
                        background: goal.completed ? "rgba(184,134,11,0.1)" : "rgba(0,0,0,0.15)",
                        borderRadius: "8px",
                        cursor: "pointer",
                        transition: "all 0.2s",
                      }}
                    >
                      <div style={{
                        width: "20px",
                        height: "20px",
                        borderRadius: "50%",
                        border: `2px solid ${goal.completed ? "#B8860B" : "#4A3F30"}`,
                        display: "flex",
                        alignItems: "center",
                        justifyContent: "center",
                        fontSize: "12px",
                        color: "#B8860B",
                        flexShrink: 0,
                      }}>
                        {goal.completed && "✓"}
                      </div>
                      <span style={{
                        fontSize: "14px",
                        textDecoration: goal.completed ? "line-through" : "none",
                        color: goal.completed ? "#6B5B45" : "#E8DCC8",
                      }}>
                        {goal.title}
                      </span>
                    </div>
                  ) : (
                    <div style={{
                      padding: "14px",
                      textAlign: "center",
                      fontSize: "12px",
                      color: "#4A3F30",
                      background: "rgba(0,0,0,0.1)",
                      borderRadius: "8px",
                      border: "1px dashed rgba(184,134,11,0.15)",
                    }}>
                      목표를 설정해 보세요
                    </div>
                  )}
                </div>
              );
            })}

            {/* Recent Goals History */}
            <div style={{ marginTop: "28px" }}>
              <div style={{
                fontSize: "11px",
                letterSpacing: "3px",
                color: "#6B5B45",
                marginBottom: "14px",
                paddingBottom: "8px",
                borderBottom: "1px solid rgba(184,134,11,0.1)",
              }}>
                완료 기록
              </div>
              {(() => {
                const completed = [];
                CATEGORIES.forEach((cat) => {
                  Object.entries(data.goals[cat.id] || {}).forEach(([key, goal]) => {
                    if (goal.completed) {
                      completed.push({ ...goal, cat, key });
                    }
                  });
                });
                completed.sort((a, b) => b.key.localeCompare(a.key));
                return completed.length > 0 ? (
                  completed.slice(0, 8).map((item, i) => (
                    <div key={i} style={{
                      display: "flex",
                      alignItems: "center",
                      gap: "10px",
                      padding: "10px 0",
                      borderBottom: "1px solid rgba(184,134,11,0.06)",
                    }}>
                      <span style={{ color: item.cat.color, fontSize: "14px" }}>{item.cat.icon}</span>
                      <div style={{ flex: 1 }}>
                        <div style={{ fontSize: "13px" }}>{item.title}</div>
                        <div style={{ fontSize: "10px", color: "#5A4E3A" }}>{item.key}</div>
                      </div>
                      <span style={{ color: "#B8860B", fontSize: "12px" }}>✓</span>
                    </div>
                  ))
                ) : (
                  <div style={{ fontSize: "12px", color: "#4A3F30", textAlign: "center", padding: "16px 0" }}>
                    아직 완료한 목표가 없습니다
                  </div>
                );
              })()}
            </div>
          </div>
        )}

        {/* Stats Tab */}
        {activeTab === "stats" && (
          <div>
            {/* Weekly Breakdown */}
            <div style={{
              marginBottom: "24px",
              padding: "20px",
              background: "rgba(184,134,11,0.06)",
              borderRadius: "12px",
              border: "1px solid rgba(184,134,11,0.12)",
            }}>
              <div style={{ fontSize: "11px", letterSpacing: "3px", color: "#6B5B45", marginBottom: "16px" }}>
                주간 연습 시간
              </div>
              {CATEGORIES.map((cat) => {
                const mins = weeklyStats[cat.id];
                const maxMins = cat.id === "hanon" ? 70 : cat.id === "czerny" ? 140 : 140;
                const pct = Math.min((mins / maxMins) * 100, 100);
                return (
                  <div key={cat.id} style={{ marginBottom: "14px" }}>
                    <div style={{
                      display: "flex",
                      justifyContent: "space-between",
                      fontSize: "12px",
                      marginBottom: "6px",
                    }}>
                      <span style={{ display: "flex", alignItems: "center", gap: "6px" }}>
                        <span style={{ color: cat.color }}>{cat.icon}</span> {cat.name}
                      </span>
                      <span style={{ color: "#8B7355", fontFamily: "'Crimson Pro', serif" }}>
                        {mins}분 / {maxMins}분
                      </span>
                    </div>
                    <div style={{
                      height: "6px",
                      background: "rgba(0,0,0,0.3)",
                      borderRadius: "3px",
                      overflow: "hidden",
                    }}>
                      <div style={{
                        height: "100%",
                        width: `${pct}%`,
                        background: `linear-gradient(90deg, ${cat.color}88, ${cat.color})`,
                        borderRadius: "3px",
                        transition: "width 0.5s ease",
                      }} />
                    </div>
                  </div>
                );
              })}
            </div>

            {/* 7-Day Heatmap */}
            <div style={{
              marginBottom: "24px",
              padding: "20px",
              background: "rgba(184,134,11,0.06)",
              borderRadius: "12px",
              border: "1px solid rgba(184,134,11,0.12)",
            }}>
              <div style={{ fontSize: "11px", letterSpacing: "3px", color: "#6B5B45", marginBottom: "16px" }}>
                최근 7일
              </div>
              <div style={{ display: "flex", gap: "6px", justifyContent: "center" }}>
                {Array.from({ length: 7 }).map((_, i) => {
                  const d = new Date();
                  d.setDate(d.getDate() - 6 + i);
                  const log = data.logs[getDayKey(d)];
                  const total = log ? (log.hanon || 0) + (log.czerny || 0) + (log.sonatine || 0) : 0;
                  const intensity = Math.min(total / 45, 1);
                  const days = ["일", "월", "화", "수", "목", "금", "토"];
                  return (
                    <div key={i} style={{ textAlign: "center", flex: 1 }}>
                      <div style={{ fontSize: "10px", color: "#5A4E3A", marginBottom: "6px" }}>
                        {days[d.getDay()]}
                      </div>
                      <div style={{
                        aspectRatio: "1",
                        borderRadius: "6px",
                        background: total > 0
                          ? `rgba(184,134,11,${0.15 + intensity * 0.6})`
                          : "rgba(0,0,0,0.2)",
                        display: "flex",
                        alignItems: "center",
                        justifyContent: "center",
                        fontSize: "11px",
                        color: total > 0 ? "#F5E6C8" : "#3D3525",
                        fontFamily: "'Crimson Pro', serif",
                        border: getDayKey(d) === todayKey ? "1px solid rgba(184,134,11,0.5)" : "none",
                      }}>
                        {total > 0 ? total : "·"}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>

            {/* Monthly Summary */}
            <div style={{
              padding: "20px",
              background: "rgba(184,134,11,0.06)",
              borderRadius: "12px",
              border: "1px solid rgba(184,134,11,0.12)",
            }}>
              <div style={{ fontSize: "11px", letterSpacing: "3px", color: "#6B5B45", marginBottom: "16px" }}>
                이번 달 요약
              </div>
              {(() => {
                let totalDays = 0;
                let totalMins = 0;
                const mk = getMonthKey(new Date());
                Object.entries(data.logs).forEach(([key, log]) => {
                  if (key.startsWith(mk)) {
                    const m = (log.hanon || 0) + (log.czerny || 0) + (log.sonatine || 0);
                    if (m > 0) {
                      totalDays++;
                      totalMins += m;
                    }
                  }
                });
                return (
                  <div style={{ display: "flex", justifyContent: "space-around", textAlign: "center" }}>
                    <div>
                      <div style={{ fontSize: "28px", fontWeight: "300", color: "#B8860B", fontFamily: "'Crimson Pro', serif" }}>
                        {totalDays}
                      </div>
                      <div style={{ fontSize: "10px", color: "#6B5B45", letterSpacing: "1px", marginTop: "4px" }}>연습일</div>
                    </div>
                    <div style={{ width: "1px", background: "rgba(184,134,11,0.15)" }} />
                    <div>
                      <div style={{ fontSize: "28px", fontWeight: "300", color: "#B8860B", fontFamily: "'Crimson Pro', serif" }}>
                        {totalMins}
                      </div>
                      <div style={{ fontSize: "10px", color: "#6B5B45", letterSpacing: "1px", marginTop: "4px" }}>총 시간(분)</div>
                    </div>
                    <div style={{ width: "1px", background: "rgba(184,134,11,0.15)" }} />
                    <div>
                      <div style={{ fontSize: "28px", fontWeight: "300", color: "#B8860B", fontFamily: "'Crimson Pro', serif" }}>
                        {totalDays > 0 ? Math.round(totalMins / totalDays) : 0}
                      </div>
                      <div style={{ fontSize: "10px", color: "#6B5B45", letterSpacing: "1px", marginTop: "4px" }}>평균(분/일)</div>
                    </div>
                  </div>
                );
              })()}
            </div>
          </div>
        )}
      </div>

      {/* Log Modal */}
      {showLogModal && (
        <div style={{
          position: "fixed",
          inset: 0,
          background: "rgba(0,0,0,0.7)",
          backdropFilter: "blur(8px)",
          display: "flex",
          alignItems: "flex-end",
          justifyContent: "center",
          zIndex: 100,
          padding: "20px",
        }}
          onClick={(e) => e.target === e.currentTarget && setShowLogModal(false)}
        >
          <div style={{
            background: "linear-gradient(180deg, #2a2010 0%, #1e1810 100%)",
            borderRadius: "16px 16px 0 0",
            border: "1px solid rgba(184,134,11,0.2)",
            borderBottom: "none",
            padding: "24px",
            width: "100%",
            maxWidth: "440px",
          }}>
            <div style={{
              width: "40px",
              height: "4px",
              background: "rgba(184,134,11,0.3)",
              borderRadius: "2px",
              margin: "0 auto 20px",
            }} />
            <div style={{ fontSize: "16px", fontWeight: "500", marginBottom: "20px", textAlign: "center" }}>
              {formatDate(selectedDate)}
            </div>

            {CATEGORIES.map((cat) => (
              <div key={cat.id} style={{ marginBottom: "16px" }}>
                <div style={{
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "space-between",
                  marginBottom: "8px",
                }}>
                  <span style={{ fontSize: "13px", display: "flex", alignItems: "center", gap: "6px" }}>
                    <span style={{ color: cat.color }}>{cat.icon}</span> {cat.name}
                  </span>
                  <span style={{ fontSize: "14px", color: "#B8860B", fontFamily: "'Crimson Pro', serif", minWidth: "40px", textAlign: "right" }}>
                    {logForm[cat.id]}분
                  </span>
                </div>
                <div style={{ display: "flex", gap: "6px", flexWrap: "wrap" }}>
                  {[0, 5, 10, 15, 20, 25, 30].map((v) => (
                    <button
                      key={v}
                      onClick={() => setLogForm((f) => ({ ...f, [cat.id]: v }))}
                      style={{
                        padding: "6px 12px",
                        borderRadius: "6px",
                        border: logForm[cat.id] === v ? `1px solid ${cat.color}` : "1px solid rgba(184,134,11,0.1)",
                        background: logForm[cat.id] === v ? `${cat.color}25` : "rgba(0,0,0,0.2)",
                        color: logForm[cat.id] === v ? "#F5E6C8" : "#6B5B45",
                        fontSize: "12px",
                        cursor: "pointer",
                        fontFamily: "'Crimson Pro', serif",
                      }}
                    >
                      {v}
                    </button>
                  ))}
                </div>
              </div>
            ))}

            <div style={{ marginBottom: "20px" }}>
              <div style={{ fontSize: "12px", color: "#6B5B45", marginBottom: "6px" }}>메모</div>
              <textarea
                value={logForm.note}
                onChange={(e) => setLogForm((f) => ({ ...f, note: e.target.value }))}
                placeholder="오늘의 연습 느낌..."
                rows={2}
                style={{
                  width: "100%",
                  background: "rgba(0,0,0,0.2)",
                  border: "1px solid rgba(184,134,11,0.15)",
                  borderRadius: "8px",
                  padding: "10px",
                  color: "#E8DCC8",
                  fontSize: "13px",
                  fontFamily: "'Noto Serif KR', serif",
                  resize: "none",
                  outline: "none",
                  boxSizing: "border-box",
                }}
              />
            </div>

            <div style={{ display: "flex", gap: "10px" }}>
              <button onClick={() => setShowLogModal(false)} style={{
                flex: 1,
                padding: "12px",
                background: "rgba(0,0,0,0.3)",
                border: "1px solid rgba(184,134,11,0.15)",
                borderRadius: "8px",
                color: "#8B7355",
                fontSize: "13px",
                cursor: "pointer",
                fontFamily: "'Noto Serif KR', serif",
              }}>
                취소
              </button>
              <button onClick={handleSaveLog} style={{
                flex: 1,
                padding: "12px",
                background: "rgba(184,134,11,0.25)",
                border: "1px solid rgba(184,134,11,0.4)",
                borderRadius: "8px",
                color: "#F5E6C8",
                fontSize: "13px",
                cursor: "pointer",
                fontFamily: "'Noto Serif KR', serif",
                fontWeight: "500",
              }}>
                저장
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Goal Modal */}
      {showGoalModal && (
        <div style={{
          position: "fixed",
          inset: 0,
          background: "rgba(0,0,0,0.7)",
          backdropFilter: "blur(8px)",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          zIndex: 100,
          padding: "20px",
        }}
          onClick={(e) => e.target === e.currentTarget && setShowGoalModal(false)}
        >
          <div style={{
            background: "linear-gradient(180deg, #2a2010 0%, #1e1810 100%)",
            borderRadius: "16px",
            border: "1px solid rgba(184,134,11,0.2)",
            padding: "24px",
            width: "100%",
            maxWidth: "400px",
          }}>
            <div style={{ fontSize: "16px", fontWeight: "500", marginBottom: "20px", textAlign: "center" }}>
              목표 설정
            </div>

            <div style={{ marginBottom: "16px" }}>
              <div style={{ fontSize: "12px", color: "#6B5B45", marginBottom: "8px" }}>카테고리</div>
              <div style={{ display: "flex", gap: "8px" }}>
                {CATEGORIES.map((cat) => (
                  <button
                    key={cat.id}
                    onClick={() => { setGoalForm((f) => ({ ...f, category: cat.id, title: "" })); setHanonStep(0); setHanonKey(""); }}                    style={{
                      flex: 1,
                      padding: "10px 8px",
                      borderRadius: "8px",
                      border: goalForm.category === cat.id
                        ? `1px solid ${cat.color}`
                        : "1px solid rgba(184,134,11,0.1)",
                      background: goalForm.category === cat.id ? `${cat.color}20` : "rgba(0,0,0,0.2)",
                      color: goalForm.category === cat.id ? "#F5E6C8" : "#6B5B45",
                      fontSize: "12px",
                      cursor: "pointer",
                      fontFamily: "'Noto Serif KR', serif",
                      textAlign: "center",
                    }}
                  >
                    <div style={{ color: cat.color, fontSize: "16px", marginBottom: "4px" }}>{cat.icon}</div>
                    {cat.name}
                  </button>
                ))}
              </div>
            </div>

            <div style={{ marginBottom: "16px" }}>
              <div style={{ fontSize: "12px", color: "#6B5B45", marginBottom: "8px" }}>
                {goalForm.category === "sonatine" ? "이번 달 곡" : goalForm.category === "hanon" ? (hanonStep === 0 ? "조성 선택" : "종류 선택") : "이번 주 곡"}
              </div>
              {goalForm.category === "hanon" ? (
                <div>
                  {hanonStep === 0 ? (
                    <>
                      <div style={{ display: "flex", gap: "6px", flexWrap: "wrap" }}>
                        {KEYS.map((k) => (
                          <button
                            key={k}
                            onClick={() => { setHanonKey(k); setHanonStep(1); }}
                            style={{
                              padding: "8px 14px",
                              borderRadius: "6px",
                              border: "1px solid rgba(184,134,11,0.15)",
                              background: "rgba(0,0,0,0.2)",
                              color: "#C4B49A",
                              fontSize: "13px",
                              cursor: "pointer",
                              fontFamily: "'Crimson Pro', serif",
                              transition: "all 0.2s",
                            }}
                          >
                            {k}
                          </button>
                        ))}
                      </div>
                    </>
                  ) : (
                    <>
                      <button
                        onClick={() => setHanonStep(0)}
                        style={{
                          background: "none",
                          border: "none",
                          color: "#6B5B45",
                          fontSize: "12px",
                          cursor: "pointer",
                          padding: "0 0 10px",
                          fontFamily: "'Noto Serif KR', serif",
                        }}
                      >
                        ‹ {hanonKey} — 종류 선택
                      </button>
                      <div style={{ display: "flex", gap: "8px", flexWrap: "wrap" }}>
                        {SCALE_TYPES.map((st) => (
                          <button
                            key={st}
                            onClick={() => setGoalForm((f) => ({ ...f, title: `${hanonKey} ${st}` }))}
                            style={{
                              padding: "10px 16px",
                              borderRadius: "8px",
                              border: goalForm.title === `${hanonKey} ${st}`
                                ? "1px solid #B8860B"
                                : "1px solid rgba(184,134,11,0.12)",
                              background: goalForm.title === `${hanonKey} ${st}`
                                ? "rgba(184,134,11,0.2)"
                                : "rgba(0,0,0,0.2)",
                              color: goalForm.title === `${hanonKey} ${st}` ? "#F5E6C8" : "#8B7355",
                              fontSize: "13px",
                              cursor: "pointer",
                              fontFamily: "'Noto Serif KR', serif",
                              transition: "all 0.2s",
                            }}
                          >
                            {st}
                          </button>
                        ))}
                      </div>
                    </>
                  )}
                </div>
              ) : (
                <input
                  value={goalForm.title}
                  onChange={(e) => setGoalForm((f) => ({ ...f, title: e.target.value }))}
                  placeholder={goalForm.category === "czerny" ? "예: No. 5" : "예: 클레멘티 소나티네 Op.36 No.1"}
                  style={{
                    width: "100%",
                    background: "rgba(0,0,0,0.2)",
                    border: "1px solid rgba(184,134,11,0.15)",
                    borderRadius: "8px",
                    padding: "10px",
                    color: "#E8DCC8",
                    fontSize: "13px",
                    fontFamily: "'Noto Serif KR', serif",
                    outline: "none",
                    boxSizing: "border-box",
                  }}
                />
              )}
            </div>

            <div style={{ display: "flex", gap: "10px" }}>
              <button onClick={() => setShowGoalModal(false)} style={{
                flex: 1,
                padding: "12px",
                background: "rgba(0,0,0,0.3)",
                border: "1px solid rgba(184,134,11,0.15)",
                borderRadius: "8px",
                color: "#8B7355",
                fontSize: "13px",
                cursor: "pointer",
                fontFamily: "'Noto Serif KR', serif",
              }}>
                취소
              </button>
              <button onClick={handleSaveGoal} style={{
                flex: 1,
                padding: "12px",
                background: "rgba(184,134,11,0.25)",
                border: "1px solid rgba(184,134,11,0.4)",
                borderRadius: "8px",
                color: "#F5E6C8",
                fontSize: "13px",
                cursor: "pointer",
                fontFamily: "'Noto Serif KR', serif",
                fontWeight: "500",
              }}>
                설정
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

const navBtnStyle = {
  background: "none",
  border: "1px solid rgba(184,134,11,0.2)",
  color: "#B8860B",
  width: "36px",
  height: "36px",
  borderRadius: "8px",
  fontSize: "18px",
  cursor: "pointer",
  display: "flex",
  alignItems: "center",
  justifyContent: "center",
};
